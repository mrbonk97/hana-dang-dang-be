<?xml version="1.0" encoding="UTF-8"?>

<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.mrbonk97.hanadangdangbe.repository.mybatis.StockMapper">
    <select id="selectStockPriceList" resultType="com.mrbonk97.hanadangdangbe.dto.StockPriceDto">
        select A.CODE,
               A.PRDT_ABRV_NAME,
               NVL(A.IDX_BZTP_MCLS_CD_NAME, '기타') as IDX_BZTP_MCLS_CD_NAME,
               B.STCK_CLPR,
               B.acml_vol,
               B.prdy_vrss,
               B.prdy_vrss_sign
        from TB_STOCK_INFO A
                 INNER JOIN TB_STOCK_PRICE_DAILY B
                            On A.CODE = B.CODE
        where B.STCK_BSOP_DATE = (select STCK_BSOP_DATE
                                  from (select STCK_BSOP_DATE from TB_STOCK_PRICE_DAILY order by STCK_BSOP_DATE desc)
                                  where rownum = 1)
        order by TO_NUMBER(ACML_VOL) desc
    </select>

    <select id="selectAccountStockList" resultType="com.mrbonk97.hanadangdangbe.dto.AccountStockDto">
        WITH TBL1 AS (select code, MAX(STCK_BSOP_DATE) RECENT_DATE
                      from TB_STOCK_PRICE_DAILY
                      group by code)
        SELECT TBL2.CODE                                                                    as code,
               TBL3.PRDT_ABRV_NAME                                                          as title,
               TBL4.QUANTITY                                                                as quantity,
               TBL4.PURCHASE_PRICE                                                          as purchase_price,
               TBL4.TOTAL_PRICE                                                             as purchase_total_price,
               TBL2.STCK_CLPR                                                               as current_price,
               TBL4.QUANTITY * TBL2.STCK_CLPR                                               AS CURRENT_TOTAL_PRICE,
               TBL4.QUANTITY * TBL2.STCK_CLPR - TBL4.TOTAL_PRICE                            as profit,
               (TBL4.QUANTITY * TBL2.STCK_CLPR - TBL4.TOTAL_PRICE) / TBL4.TOTAL_PRICE * 100 as profit_percentage
        FROM TB_ACCOUNT_STOCK TBL4
                 INNER JOIN TBL1
                            ON SUBSTR(TBL4.STOCK_INFO_PDNO, 7) = TBL1.CODE
                 INNER JOIN TB_STOCK_PRICE_DAILY TBL2
                            ON TBL1.CODE = TBL2.CODE AND TBL1.RECENT_DATE = TBL2.STCK_BSOP_DATE
                 INNER JOIN TB_STOCK_INFO TBL3
                            ON TBL1.CODE = TBL3.CODE
        WHERE TBL4.ACCOUNT_ACCOUNT_NO = #{accountNo}
        ORDER BY TBL4.TOTAL_PRICE DESC
    </select>


    <select id="selectAccountProfitEstimate" resultType="com.mrbonk97.hanadangdangbe.dto.AccountProfitEstimateDto">
        SELECT A.id,
               C.CODE,
               C.PRDT_ABRV_NAME              as title,
               A.QUANTITY,
               A.PURCHASE_PRICE,
               A.TOTAL_PRICE,
               NVL(A.QUANTITY * B.AMOUNT, 0) AS ESTIMATE_PROFIT,
               NVL(B.AMOUNT, 0)              as amount,
               NVL(B.PERCENTAGE, 0)          as percentage
        FROM TB_ACCOUNT_STOCK A
                 INNER JOIN TB_STOCK_INFO C
                            ON A.STOCK_INFO_PDNO = C.PDNO
                 LEFT OUTER JOIN (SELECT CODE,
                                         TITLE,
                                         SUM(AMOUNT)           AS AMOUNT,
                                         AVG(YIELD_PERCENTAGE) AS PERCENTAGE
                                  FROM (SELECT *
                                        FROM TB_DIVIDEND_HISTORY
                                        WHERE LOCK_DATE &gt;= TO_DATE('2023-01-01', 'YYYY-MM-DD')
                                          AND LOCK_DATE &lt;= TO_DATE('2023-12-31 23:59:59', 'YYYY-MM-DD HH24:MI:SS'))
                                  GROUP BY CODE, TITLE) B ON SUBSTR(A.STOCK_INFO_PDNO, 7) = B.CODE
        WHERE A.ACCOUNT_ACCOUNT_NO = #{accountNo}
        ORDER BY AMOUNT DESC
    </select>

    <select id="selectAccountMonthlyProfitEstimate"
            resultType="com.mrbonk97.hanadangdangbe.dto.AccountMonthlyProfitEstimateDto">
        SELECT A.id,
               B.CODE,
               B.TITLE,
               A.QUANTITY,
               A.PURCHASE_PRICE,
               A.TOTAL_PRICE,
               NVL(A.QUANTITY * B.AMOUNT, 0) AS ESTIMATE_PROFIT,
               NVL(B.AMOUNT, 0)              as amount,
               NVL(B.YIELD_PERCENTAGE, 0)    as percentage,
               B.PAY_DATE
        FROM TB_ACCOUNT_STOCK A
                 LEFT OUTER JOIN (SELECT CODE,
                                         TITLE,
                                         AMOUNT,
                                         YIELD_PERCENTAGE,
                                         PAY_DATE
                                  FROM (SELECT *
                                        FROM TB_DIVIDEND_HISTORY
                                        WHERE PAY_DATE &gt;= TO_DATE('2023-01-01', 'YYYY-MM-DD')
                                          AND PAY_DATE &lt;=
                                              TO_DATE('2023-12-31 23:59:59', 'YYYY-MM-DD HH24:MI:SS'))) B
                                 ON SUBSTR(A.STOCK_INFO_PDNO, 7) = B.CODE
        WHERE A.ACCOUNT_ACCOUNT_NO = #{accountNo}
          AND CODE IS NOT NULL
        ORDER BY PAY_DATE DESC
    </select>
    <select id="selectfindStockByName" resultType="com.mrbonk97.hanadangdangbe.dto.SearchStockDto">
        select A.PRDT_ABRV_NAME, A.CODE, D.STCK_CLPR, D.PRDY_VRSS
        from TB_STOCK_INFO A
                 INNER JOIN(select B.*
                            FROM TB_STOCK_PRICE_DAILY B
                                     INNER JOIN(select code, MAX(STCK_BSOP_DATE) AS RECENT_DATE
                                                from TB_STOCK_PRICE_DAILY
                                                GROUP BY CODE) C
                                               ON B.CODE = C.CODE AND B.STCK_BSOP_DATE = C.RECENT_DATE) D
                           ON A.CODE = D.CODE
        WHERE A.PRDT_NAME LIKE '%' || #{keyword} || '%'
    </select>

    <select id="selectfindStockListPage" resultType="com.mrbonk97.hanadangdangbe.dto.StockListDto">
        select *
        FROM (select ROWNUM as RN,
                     PRDT_ABRV_NAME,
                     code,
                     std_idst_clsf_cd_name,
                     stck_clpr,
                     acml_vol,
                     ACML_TR_PBMN,
                     prdy_vrss
              FROM (select A.PRDT_ABRV_NAME,
                           A.code,
                           A.std_idst_clsf_cd_name,
                           D.stck_clpr,
                           D.acml_vol,
                           D.ACML_TR_PBMN,
                           D.prdy_vrss
                    from TB_STOCK_INFO A
                             INNER JOIN (select B.*
                                         FROM TB_STOCK_PRICE_DAILY B
                                                  INNER JOIN (select code, MAX(STCK_BSOP_DATE) AS RECENT_DATE
                                                              from TB_STOCK_PRICE_DAILY
                                                              GROUP BY CODE) C
                                                             ON B.CODE = C.CODE AND B.STCK_BSOP_DATE = C.RECENT_DATE) D
                                        ON A.CODE = D.CODE
                    ORDER BY TO_NUMBER(D.ACML_TR_PBMN) DESC))
        WHERE RN &gt; #{page} * 50
          AND RN &lt;= (#{page} + 1) * 50

    </select>
</mapper>